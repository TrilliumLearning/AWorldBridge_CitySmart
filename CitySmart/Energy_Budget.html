<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <style>
        #more {
            display: none;
        }
        #graphdiv {
            display: none;
        }

        .dygraph-title { text-align: center; font-weight: bold;}
        .dygraph-xlabel { text-align: center;}
    </style>
</head>
<body>
    <div>
        <h4>Test drop down list</h4>
        <select id = "dropDown">
            <option value = "null">Select</option>
            <option value = "budget">Energy Budget</option>
            <option value = "actual">Actual vs Prediction</option>
            <option value = "percentage"> </option>
        </select><br><br>

        <div id = "more">
            <h4>Select Date: <input type="date" id="date"></h4>

            <h4>Select Time</h4>
            <select id = "time">
                <option value = "null">Select</option>
                <option value = "T00:00:00Z">0:00 - 1:00</option>
                <option value = "T01:00:00Z">1:00 - 2:00</option>
                <option value = "T02:00:00Z">2:00 - 3:00</option>
                <option value = "T03:00:00Z">3:00 - 4:00</option>
                <option value = "T04:00:00Z">4:00 - 5:00</option>
                <option value = "T05:00:00Z">5:00 - 6:00</option>
                <option value = "T06:00:00Z">6:00 - 7:00</option>
                <option value = "T07:00:00Z">7:00 - 8:00</option>
                <option value = "T08:00:00Z">8:00 - 9:00</option>
                <option value = "T09:00:00Z">9:00 - 10:00</option>
                <option value = "T10:00:00Z">10:00 - 11:00</option>
                <option value = "T11:00:00Z">11:00 - 12:00</option>
                <option value = "T12:00:00Z">12:00 - 13:00</option>
                <option value = "T13:00:00Z">13:00 - 14:00</option>
                <option value = "T14:00:00Z">14:00 - 15:00</option>
                <option value = "T15:00:00Z">15:00 - 16:00</option>
                <option value = "T16:00:00Z">16:00 - 17:00</option>
                <option value = "T17:00:00Z">17:00 - 18:00</option>
                <option value = "T18:00:00Z">18:00 - 19:00</option>
                <option value = "T19:00:00Z">19:00 - 20:00</option>
                <option value = "T20:00:00Z">20:00 - 21:00</option>
                <option value = "T21:00:00Z">21:00 - 22:00</option>
                <option value = "T22:00:00Z">22:00 - 23:00</option>
                <option value = "T23:00:00Z">23:00 - 24:00</option>
            </select><br><br>
        </div>

        <input type="button" onclick='ajaxFunction()' value = "click here">
    </div>

    <div id="graphdiv"></div>
    <canvas id="graphcanvas"></canvas>

</body>
<script src="node_modules/dygraphs/dist/dygraph.js"></script>
<script src="node_modules/chart.js/dist/Chart.js"></script>
<script>
    function ajaxFunction(){
        var ajaxRequest;  // The variable that makes Ajax possible!
        try{

            // Opera 8.0+, Firefox, Safari
            ajaxRequest = new XMLHttpRequest();
        }catch (e){

            // Internet Explorer Browsers
            try{
                ajaxRequest = new ActiveXObject("Msxml2.XMLHTTP");
            }catch (e) {

                try{
                    ajaxRequest = new ActiveXObject("Microsoft.XMLHTTP");
                }catch (e){

                    // Something went wrong
                    alert("Your browser broke!");
                    return false;
                }
            }
        }

        // Create a function that will receive data
        // sent from the server and will update
        // div section in the same page.

        ajaxRequest.onreadystatechange = function(){

            //alert("xhr status: " + ajaxRequest.readyState);

            if (ajaxRequest.readyState == 4 || ajaxRequest.status == 200) {
                var ajaxReturn = JSON.parse(ajaxRequest.responseText);
                var graphdata = [];
                var machineName = [];
                var machineUsage = [];

                if (graphName === "budget") {
                    for (var i = 0; i < ajaxReturn.length; i++) {
                        if (!graphdata[i]) {
                            graphdata[i] = [];
                        }
                        graphdata[i][0] = new Date(ajaxReturn[i].time);
                        graphdata[i][1] = ajaxReturn[i].Electricity_Usage;
                    }

                    new Dygraph(document.getElementById("graphdiv"),
                        graphdata,
                        {
                            title: "Energy_Budget",
                            drawPoints: true,
                            labels: ["Dates", "Electricity_Usage"],
                            showRoller: true,
                            showRangeSelector: false,
                        }
                    );
                }

                if (graphName === "actual") {
                    for (var i = 0; i < ajaxReturn.length; i++) {
                        if (!graphdata[i]) {
                            graphdata[i] = [];
                        }
                        graphdata[i][0] = new Date(ajaxReturn[i].time);
                        graphdata[i][1] = ajaxReturn[i].Actual_Electricity_Usage;
                        graphdata[i][2] = ajaxReturn[i].Predict_Electricity_Usage;
                    }

                    //http://dygraphs.com/tests/plotters.html
                    function darkenColor(colorStr) {
                        // Defined in dygraph-utils.js
                        var color = Dygraph.toRGB_(colorStr);
                        color.r = Math.floor((255 + color.r) / 2);
                        color.g = Math.floor((255 + color.g) / 2);
                        color.b = Math.floor((255 + color.b) / 2);
                        return 'rgb(' + color.r + ',' + color.g + ',' + color.b + ')';
                    }

                    //http://dygraphs.com/tests/plotters.html
                    function multiColumnBarPlotter(e) {
                        // We need to handle all the series simultaneously.
                        if (e.seriesIndex !== 0) return;

                        var g = e.dygraph;
                        var ctx = e.drawingContext;
                        var sets = e.allSeriesPoints;
                        var y_bottom = e.dygraph.toDomYCoord(0);

                        // Find the minimum separation between x-values.
                        // This determines the bar width.
                        var min_sep = Infinity;
                        for (var j = 0; j < sets.length; j++) {
                            var points = sets[j];
                            for (var i = 1; i < points.length; i++) {
                                var sep = points[i].canvasx - points[i - 1].canvasx;
                                if (sep < min_sep) min_sep = sep;
                            }
                        }
                        var bar_width = Math.floor(2.0 / 3 * min_sep);

                        var fillColors = [];
                        var strokeColors = g.getColors();
                        for (var i = 0; i < strokeColors.length; i++) {
                            fillColors.push(darkenColor(strokeColors[i]));
                        }

                        for (var j = 0; j < sets.length; j++) {
                            ctx.fillStyle = fillColors[j];
                            ctx.strokeStyle = strokeColors[j];
                            for (var i = 0; i < sets[j].length; i++) {
                                var p = sets[j][i];
                                var center_x = p.canvasx;
                                var x_left = center_x - (bar_width / 2) * (1 - j/(sets.length-1));

                                ctx.fillRect(x_left, p.canvasy,
                                    bar_width/sets.length, y_bottom - p.canvasy);

                                ctx.strokeRect(x_left, p.canvasy,
                                    bar_width/sets.length, y_bottom - p.canvasy);
                            }
                        }
                    }

                    new Dygraph(document.getElementById("graphdiv"),
                        graphdata,
                        {
                            title: "Actual vs Predict",
                            drawPoints: true,
                            labels: ["Month", "Actual_Electricity_Usage", "Predict_Electricity_Usage"],
                            xlabel: "Month",
                            ylabel: "kWh",
                            showRoller: true,
                            showRangeSelector: false,
                            dateWindow: [ Date.parse("2016/08/01"), Date.parse("2017/09/01") ],
                            plotter: multiColumnBarPlotter
                        }
                    );
                }

                if (graphName === "percentage") {
                    for (var i = 0; i < ajaxReturn.length; i++) {
                        machineName[i] = ajaxReturn[i].Machine_Name;
                        machineUsage[i] = ajaxReturn[i].Electricity_Usage;
                    }

                    new Chart(document.getElementById("graphcanvas"), {
                        // The type of chart we want to create
                        type: 'polarArea',

                        // The data for our dataset
                        data: {
                            labels: machineName,
                            datasets: [{
                                data: machineUsage,
                            }]
                        },

                        // Configuration options go here
                        options: {

                        }
                    });
                }
            }
        };

        var graphSelect = document.getElementById("dropDown");
        var graphName = graphSelect.options[graphSelect.selectedIndex].value;
        var queryString1 = "?keywords=" + graphName;

        var x = document.getElementById('more');
        var y = document.getElementById('graphdiv');
        var z = document.getElementById('graphcanvas');

        alert("QueryString: " + queryString1);

        if (graphName === "budget" || graphName === "actual") {
            x.style.display = 'none';
            y.style.display = 'block';
            z.style.display = 'none';

            ajaxRequest.open("GET", "//aworldbridgelabs.com:9085/graph" + queryString1, true);
            ajaxRequest.send(queryString1);

        } else if (graphName === "percentage") {
            x.style.display = 'block';
            y.style.display = 'none';
            z.style.display = 'block';

            var date = document.getElementById("date").value;

            var time = document.getElementById("time").value;

            var queryString2 = "?keywords=" + date + time;
            alert("QueryString: " + queryString2);

            if (queryString2 !== "?keywords=null") {
                ajaxRequest.open("GET", "//aworldbridgelabs.com:9085/graph" + queryString2, true);
                ajaxRequest.send(queryString2);
            }
        }
    }
    //-->
</script>
</html>
